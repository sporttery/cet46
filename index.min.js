const fs=require("fs"),path=require("path"),readline=require("readline"),iconv=require("iconv-lite"),exec=require("child_process").exec,{shell:shell}=require("electron");var configuration=require("./configuration"),folderArr=[],folderEleArr=[],folderArrIdx=0,defaultFolderArr=[],defaultTableData=[],tableData=[],alert_like,defaultNavTab=0,g_data_changed=-1,layerLoadIdx,chk_tlmk,bskssj,kykssj,templateHtml='<html><head>  <meta http-equiv=Content-Type content="text/html; charset=utf8">  <style>  \x3c!--   /* Font Definitions */  @page Section1      {size:11.0in 8.5in;      mso-page-orientation:landscape;      margin:1.25in 1.0in 1.25in 1.0in;      mso-header-margin:35.4pt;      mso-footer-margin:35.4pt;      mso-paper-source:0;}  div.Section1      {page:Section1;}  --\x3e  </style>  <style>    .title {font-family: "宋体"; font-size:12pt; font-weight:bold;}    .table {border-bottom: 1px solid black; border-top: 1px solid black;}    .header {border-bottom: 1px solid black;}    div, td {font-size: 10.5pt;}  </style></head><body><div class=Section1 style="mso-page-orientation:landscape;">###content###</div></body></html>';function setFolder(){var filepath=document.getElementById("folderBtn").files[0].path;folderArr[folderArrIdx]=filepath,folderEleArr[folderArrIdx].val(filepath),document.getElementById("folderBtn").value="",g_data_changed=0}function checkFolder(noAlert){if(0==folderArr.length)return!noAlert&&alert("请先完成数据配置"),folderEleArr[0][0].focus(),!1;for(var i=0;i<folderEleArr.length;i++){var checked=!0,msg="未完成",statsObj;if(folderArr[i]&&""!=folderArr[i]||(checked=!1),checked&&(checked=fs.existsSync(folderArr[i]),msg=folderArr[i]+" 无效路径"),checked)checked=fs.statSync(folderArr[i]).isDirectory(),msg=folderArr[i]+" 不是文件夹";if(!checked)return!noAlert&&alert('<span style="color:red;font-weight:bold">'+folderEleArr[i].prev().text()+"</span>"+msg),folderEleArr[i][0].focus(),!1}return!0}function nextStep(n){if(-1!=g_data_changed)return alert("数据有变化，请先保存或者重置！"),void $(".nav a")[g_data_changed].click();0===n?checkFolder()&&(0==tableData.length?$(".nav-tabs .active").next().next().find("a")[0].click():($("#btnFindFile").removeAttr("disabled").removeClass("disabled"),$(".nav-tabs .active").next().find("a")[0].click())):0==tableData.length?alert("请先设置数据定义"):($("#btnFindFile").removeAttr("disabled").removeClass("disabled"),$(".nav-tabs .active").prev().find("a")[0].click())}function timeClose(id,seconds){seconds||(seconds=4),setTimeout((function(){$("#"+id).modal("hide")}),1e3*seconds)}function alert(msg,title,callback,cancelFn){title?(alert_like||(alert_like=$("#alert_like")),title&&alert_like.find("#myModalLabel").html(title),alert_like.find("#modal_con").html("<p>"+msg+"</p>"),alert_like.modal(),callback?(alert_like.find(".close").removeAttr("data-dismiss").click(()=>{callback(),alert_like.is(":visible")&&alert_like.modal("hide")}),alert_like.find("#ok_btn").removeAttr("data-dismiss").click(()=>{callback(),alert_like.is(":visible")&&alert_like.modal("hide")}),cancelFn&&(alert_like.find(".modal-footer").append('<button id="cancel_btn" class="btn btn-sm btn-warning">退 出</button>'),alert_like.find("#cancel_btn").click(()=>{cancelFn(),alert_like.is(":visible")&&alert_like.modal("hide")}))):(alert_like.find(".close").attr("data-dismiss","modal"),alert_like.find("#ok_btn").attr("data-dismiss","modal"),alert_like.find("#cancel_btn").remove())):layer.alert(msg)}function restore(flag){if(flag)tableData=[].concat(defaultTableData),setTableData(),document.getElementById("fileBtn").value="";else{for(var i=0;i<folderEleArr.length;i++)defaultFolderArr[i]?(folderEleArr[i].val(defaultFolderArr[i]),folderArr[i]=defaultFolderArr[i]):(folderEleArr[i].val(""),folderArr[i]="");document.getElementById("folderBtn").value=""}g_data_changed=-1}function checkFileColumns(noAlert){for(var allNo=[],i=0;i<tableData.length;i++){var config=tableData[i];if(config["排序号"]=parseInt(config["排序号"]),isNaN(config["排序号"]))return!noAlert&&alert("第"+(i+1)+"项排序号不是数字，请重新指定一个"),!1;if(allNo.includes(config["排序号"]))return!noAlert&&alert("第"+(i+1)+"项排序号已经存在，排序号不能重复，请重新指定一个"),!1;if((config["照片"]||config["二维码"])&&!config["启用"])return!noAlert&&alert("第"+(i+1)+"项配置错误，在未启用的字段上配置照片或者二维码!"),!1;allNo.push(config["排序号"])}return!0}function save(flag){if(flag){if(checkFileColumns()){cleanCache();var ks_type=$("#ks_type").val(),ks_date,tableKey="tableData_"+$("#ks_date").val()+"_"+ks_type;configuration.saveSettings(tableKey,JSON.stringify(tableData)),defaultTableData=[].concat(tableData),checkFolder(!0)&&$("#btnFindFile").removeAttr("disabled").removeClass("disabled"),alert("数据已经保存"),g_data_changed=-1}}else checkFolder()&&(configuration.saveSettings("folderArr",JSON.stringify(folderArr)),defaultFolderArr=[].concat(folderArr),tableData.length>0&&$("#btnFindFile").removeAttr("disabled").removeClass("disabled"),alert("数据已经保存"),g_data_changed=-1)}function tlmkChage(){chk_tlmk=$("#chk_tlmk")[0].checked;var ks_type=$("#ks_type").val(),ks_date,tlmk_key="chk_tlmk_"+$("#ks_date").val()+"_"+ks_type;configuration.saveSettings(tlmk_key,chk_tlmk)}function kssjChage(){var ks_type=$("#ks_type").val(),ks_date=$("#ks_date").val();bskssj=$("#bskssj").val(),kykssj=$("#kykssj").val();var kssj_key="kssj_"+ks_date+"_"+ks_type;configuration.saveSettings(kssj_key+"_ky",kykssj),configuration.saveSettings(kssj_key+"_bs",bskssj)}function loadDefaultConfig(){var ks_type=$("#ks_type").val(),ks_date=$("#ks_date").val(),tableKey="tableData_"+ks_date+"_"+ks_type,folderArr=configuration.readSettings("folderArr");defaultFolderArr=folderArr?JSON.parse(folderArr):[];var tableData=configuration.readSettings(tableKey);defaultTableData=tableData?JSON.parse(tableData):[],defaultNavTab=configuration.readSettings("defaultNavTab")||0;var tlmk_key="chk_tlmk_"+ks_date+"_"+ks_type;chk_tlmk=configuration.readSettings(tlmk_key);var kssj_key="kssj_"+ks_date+"_"+ks_type;kykssj=configuration.readSettings(kssj_key+"_ky"),bskssj=configuration.readSettings(kssj_key+"_bs"),kykssj||(kykssj="2021年11月",configuration.saveSettings(kssj_key+"_ky",kykssj)),bskssj||(bskssj="2021年12月",configuration.saveSettings(kssj_key+"_bs",bskssj))}function selectAll(obj,id){$("#"+id+" input:checkbox").each((idx,chk)=>{chk.checked=obj.checked,$(chk).change()})}const allowFileName={"CET4|英语四级":1,"CET6|英语六级":1,"CJT4|日语四级":1,"CJT6|日语六级":1,"CGT4|德语四级":1,"CGT6|德语六级":1,"CRT4|俄语四级":1,"CRT6|俄语六级":1,"CFT4|法语四级":1,"CFT6|法语六级":1};function getFiles(sourceDir,includeSubFolder,filetypes){const allowFileNameReg=new RegExp("^("+$("#ks_type").val()+")_\\d+\\..*$");let allfiles=[];function findFiles(dir,includeSubFolder,filetypes){let files;fs.readdirSync(dir).forEach((function(item,index){let fPath=path.join(dir,item),stat=fs.statSync(fPath);if(!0===stat.isDirectory()&&includeSubFolder&&findFiles(fPath,includeSubFolder,filetypes),!0===stat.isFile()){var extname=path.extname(fPath),basename=path.basename(fPath);"string"==typeof filetypes?"*"!==filetypes&&extname!=filetypes||allowFileNameReg.test(basename)&&allfiles.push({filepath:fPath,size:stat.size}):"object"==typeof filetypes&&filetypes.includes&&filetypes.includes(extname)&&allowFileNameReg.test(basename)&&allfiles.push({filepath:fPath,size:stat.size})}}))}return findFiles(sourceDir,includeSubFolder,filetypes),allfiles}function openFile(idx){var filepath;idx&&(filepath=isNaN(idx)?idx:allDataFiles[idx].filepath,shell.openItem(filepath))}function openDir(idx){var dir;idx&&(dir=isNaN(idx)?idx:path.dirname(allDataFiles[idx].filepath),shell.openItem(dir))}const Kilobyte=1024,Megabyte=1048576,Gigabyte=1073741824,Terabyte=1099511627776;function getFileSize(len){return len>Terabyte?(len/Terabyte).toFixed(2)+" TB":len>Gigabyte?(len/Gigabyte).toFixed(2)+" GB":len>1048576?(len/1048576).toFixed(2)+" MB":len>1024?(len/1024).toFixed(2)+" KB":len+" B"}var allDataFiles=[],progressbar;function findFile(obj){allDataFiles=[],$(obj).attr("disabled","disabled").addClass("disabled");var includeSubFolder=$("#includeSubFolder")[0].checked,filetype=$("#filetype").val();allDataFiles=getFiles(folderArr[0],includeSubFolder,filetype);var html=[];allDataFiles.forEach((file,idx)=>{var filepath=file.filepath;html.push("<tr>"),html.push('<td><input type="checkbox" class="filecbx" onchange="filecbxChange()" value="'+idx+'" id="fileIdx'+idx+'" style="cursor:pointer;width:20px;height:20px"/></td>'),html.push('<td title="'+filepath+'"><a href="javascript:openFile('+idx+')" class="btn btn-link">'+path.basename(filepath)+"</a>"+getFileSize(file.size)+' <a href="javascript:openDir('+idx+')" title="打开所在目录 '+path.dirname(filepath)+'">目录</a></td>'),html.push("<td>未开始</td>"),html.push("<td>未开始</td>"),html.push("</tr>")}),html.length>0?$("#fileData").html(html.join("")):alert("*"!=filetype?'没有找到数据文件，当前只查找后缀"'+filetype+'"的文件，切换成"所有文件"试试<p>文件名必须以<p>'+Object.keys(allowFileName).join(",")+"</p>开头,【_省份】 结尾 ， 如 【CET4_12.csv】":"没有找到数据文件，请确认源数据目录是否正确,<p>文件名必须以<p>"+Object.keys(allowFileName).join(",")+"</p>开头,【_省份】 结尾 ， 如 【CET4_12.csv】"),$(obj).removeAttr("disabled","disabled").removeClass("disabled")}function filecbxChange(){var len;$(".filecbx:checked").length>0?$("#btnData").removeAttr("disabled","disabled").removeClass("disabled"):$("#btnData").attr("disabled","disabled").addClass("disabled")}function setProgressbar(value,txt){progressbar||(progressbar=$("#progressbar")[0]),0==value?(progressbar.style.width=value+"%",progressbar.innerText=""):(txt||(txt=value+"%"),progressbar.style.width=value+"%",progressbar.innerText=txt)}function getByteLen(str){return str.replace(/[^\x00-\xff]/g,"xxx").length}function wait(second){let ChildProcess_ExecSync=require("child_process").execSync;try{ChildProcess_ExecSync("powershell sleep "+second)}catch(error){try{ChildProcess_ExecSync("sleep "+second)}catch(error){}}}var kyDataMap={A:1,"A+":1,B:1,"B+":1,C:1,"C+":1,"--":1},checkDataFun={DEFAULT:function(currData,sf){var ks_zkz,_sf,err=[];currData.KS_ZKZ.substring(0,2)!=sf&&err.push("准考证号的省份不一致");var ks_bmh=currData.KS_BMH,_xxdm=ks_bmh.substring(0,5),_xqdm=ks_bmh[5],_yyjb=ks_bmh[6];return picFolder=path.join(folderArr[1],sf,_xxdm,_xqdm,_yyjb),-1!=picIndex?fs.existsSync(path.join(picFolder,currData["照片"]+".jpg"))?currData["照片"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["照片"]+".jpg"):fs.existsSync(path.join(picFolder,currData["照片"]+".png"))?currData["照片"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["照片"]+".png"):err.push("照片不存在 ["+path.join(picFolder,currData["照片"]+".jpg")+"]"):currData["照片"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["照片"]+".jpg"),picFolder=path.join(folderArr[2],sf,_xxdm,_xqdm,_yyjb),-1!=qrcodeIndex?fs.existsSync(path.join(picFolder,currData["二维码"]+".png"))?currData["二维码"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["二维码"]+".png"):fs.existsSync(path.join(picFolder,currData["二维码"]+".jpg"))?currData["二维码"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["二维码"]+".jpg"):err.push("二维码不存在 ["+path.join(picFolder,currData["二维码"]+".jpg")+"]"):currData["二维码"]=path.join(sf,_xxdm,_xqdm,_yyjb,currData["二维码"]+".png"),currData.KS_ZKZ_XS?15==currData.KS_ZKZ_XS.length?currData["笔试考试时间"]=bskssj:"--"==currData.KS_ZKZ_XS?currData["笔试考试时间"]="--":err.push("笔试考试时间所需要字段(ks_zkz_xs)值不符合要求"):currData["笔试考试时间"]="--",currData.KY_ZKZ?15==currData.KY_ZKZ.length?currData["口语考试时间"]=kykssj:"--"==currData.KY_ZKZ?currData["口语考试时间"]="--":err.push("口语考试时间所需要字段(ky_zkz)值不符合要求"):currData["口语考试时间"]="--",err.length>0?err.join(","):""}},EMPTY,EMPTYOBJ;checkDataFun.CET=function(currData,sf){var defalutCheckResult=checkDataFun.DEFAULT(currData,sf);if(""!=defalutCheckResult)return defalutCheckResult;var ks_zkz=currData.KS_ZKZ,ky_zkz=currData.KY_ZKZ,ky_sco=currData.KY_SCO,err=[],_yyjb=ks_zkz[9];return"--"!=ky_zkz&&1==_yyjb&&"F"!=ky_zkz[0]&&err.push("语言级别和口试准考证第一位没有对应"),"--"!=ky_zkz&&2==_yyjb&&"S"!=ky_zkz[0]&&err.push("语言级别和口试准考证第一位没有对应"),kyDataMap[ky_sco]||err.push("口语成绩["+ky_sco+"]不符合"),err.length>0?err.join(","):""},checkDataFun.CET4=checkDataFun.CET,checkDataFun.CET6=checkDataFun.CET,checkDataFun["英语四级"]=checkDataFun.CET,checkDataFun["英语六级"]=checkDataFun.CET;var picIndex=-1,qrcodeIndex=-1,enabledColumns,progressData={len:0,size:0,currSize:0,lastProgress:0};function cleanCache(){delete EMPTY,delete EMPTYOBJ,enabledColumns=!1,progressData={len:0,size:0,currSize:0,lastProgress:0},chk_tlmk=$("#chk_tlmk")[0].checked}function analyticHandle(file,inputEl){let totalSize=file.size,nowStr="."+getDateStr(),tds=$(inputEl).parent().siblings();$(tds[tds.length-1]).text("准备中");let allDataInFile={},allOkStrInFile={},filename=path.basename(file.filepath),ext=path.extname(file.filepath),okFilepath=path.join(folderArr[3],""==ext?filename+nowStr+".ok.csv":filename.replace(ext,nowStr+".ok.csv")),errFilepath=path.join(folderArr[4],path.basename(okFilepath).replace(".ok.csv",".err.csv")),sf=filename.split(/[_.]/g)[1],lang=filename.substring(0,4),validFun=checkDataFun[lang];validFun||(validFun=checkDataFun.DEFAULT);let sumlen=0,lineCount=0,lastProgress="",errCount=0,head=[];if(!enabledColumns){enabledColumns={},EMPTY="0,",EMPTYOBJ={PageNo:"0"};for(let i=0;i<tableData.length;i++){let config=tableData[i];config["启用"]&&(config["照片"]&&(picIndex=i),config["二维码"]&&(qrcodeIndex=i),enabledColumns["_"+i]=parseInt(config["排序号"]),EMPTY+="0,",EMPTYOBJ[config["内容"]]="0",head[parseInt(config["排序号"])]=config["内容"])}-1!=picIndex&&(EMPTY+="empty.jpg,",EMPTYOBJ["照片"]="empty.jpg"),-1!=qrcodeIndex&&(EMPTY+="empty.jpg",EMPTYOBJ["二维码"]="empty.jpg"),-1==picIndex&&-1==qrcodeIndex&&(EMPTY=EMPTY.substring(0,EMPTY.length-1))}let headLine=["PageNo"];for(var i=0;i<head.length;i++)head[i]&&headLine.push(head[i]);headLine.push("照片"),headLine.push("二维码"),headLine.push("笔试考试时间"),headLine.push("口语考试时间"),chk_tlmk&&(headLine.push("chk_tlmk"),EMPTYOBJ.chk_tlmk="0",EMPTY+=",0");let headLineStr='"'+headLine.join('","')+'"\r\n';fs.appendFileSync(okFilepath,iconv.encode(headLineStr,"gbk"),"binary"),$(tds[tds.length-1]).text("进行中");let readObj=readline.createInterface({input:fs.createReadStream(file.filepath)});readObj.on("line",(function(line){if(-1==errCount)return;let lineLen=getByteLen(line)+2;if(sumlen+=lineLen,progressData.currSize+=lineLen,(line=line.replace(/["']/g,"").trim()).length>0&&"K"!=line[0].toUpperCase()){lineCount++;let currProgress=Math.floor(100*sumlen/totalSize);lastProgress!=currProgress&&(tds[1].innerText=currProgress>90?"统计中":"["+currProgress+"%]",lastProgress=currProgress);let progress=Math.floor(100*progressData.currSize/progressData.size);progress!=progressData.lastProgress&&(setProgressbar(progress),progressData.lastProgress=progress);let columns=line.split(/[,\t]/g);if(columns.length!=tableData.length)return alert("文件"+file.filepath+" 第"+lineCount+"行 数据缺失，与定义字段的个数不一致！"),errCount=-1,readObj.close(),layer.close(layerLoadIdx),!1;let outputData=[],currData={};for(let i=0;i<columns.length;i++){let sortNum=enabledColumns["_"+i];currData[tableData[i]["内容"]]=columns[i].replace(".00",""),sortNum&&(outputData[sortNum]=columns[i].replace(".00",""),picIndex==i&&(currData["照片"]=columns[i]),qrcodeIndex==i&&(currData["二维码"]=columns[i]))}let errMsg=validFun(currData,sf);""==errMsg&&(outputData[tableData.length+1]=currData["照片"],outputData[tableData.length+2]=currData["二维码"],outputData[tableData.length+3]=currData["笔试考试时间"],outputData[tableData.length+4]=currData["口语考试时间"],chk_tlmk&&("0"==currData.KS_TLMK?outputData[tableData.length+5]=" ":"1"==currData.KS_TLMK&&(outputData[tableData.length+5]="该考生为听力残疾，听力部分免考，分数经折算计入笔试总分。")));let finalData=[],kddm=currData.KS_ZKZ.substring(0,5),ks_ssxx=currData.KS_SSXX;for(let i=0;i<outputData.length;i++)void 0!==outputData[i]&&finalData.push(outputData[i]);var csvLineStr='"'+finalData.join('","')+'"';""!=errMsg?(errCount++,csvLineStr=csvLineStr+',"'+errMsg+'"',fs.appendFileSync(errFilepath,csvLineStr+"\r\n")):(allOkStrInFile[kddm]||(allOkStrInFile[kddm]={}),allOkStrInFile[kddm][ks_ssxx]||(allOkStrInFile[kddm][ks_ssxx]=[]),allOkStrInFile[kddm][ks_ssxx].push(csvLineStr),allDataInFile[kddm]||(allDataInFile[kddm]={}),allDataInFile[kddm][ks_ssxx]||(allDataInFile[kddm][ks_ssxx]=[]),allDataInFile[kddm][ks_ssxx].push(currData))}})),readObj.on("close",(function(e){if(-1==errCount)return;let pakFilepath=okFilepath.replace(".ok.csv",".pak.txt");fs.existsSync(pakFilepath)&&fs.unlinkSync(pakFilepath),console.log(okFilepath+" saving...");let tables=[];for(let kddm in allOkStrInFile)for(let ssxx in allOkStrInFile[kddm]){let tmpArr=[[],[],[],[]],list=allOkStrInFile[kddm][ssxx];list.sort((a,b)=>{tmpA=a.split('","'),tmpB=b.split('","'),DM_MC_IDX=9,KS_BMXQ_IDX=10,KS_XY_IDX=11,KS_ZSH_IDX=0;var zsh_a=parseInt(tmpA[KS_ZSH_IDX].replace(/\D/g,"")),zsh_b=parseInt(tmpB[KS_ZSH_IDX].replace(/\D/g,""));return tmpA[KS_BMXQ_IDX]>tmpB[KS_BMXQ_IDX]?1:tmpA[KS_BMXQ_IDX]<tmpB[KS_BMXQ_IDX]?-1:tmpA[DM_MC_IDX]>tmpB[DM_MC_IDX]?1:tmpA[DM_MC_IDX]<tmpB[DM_MC_IDX]?-1:tmpA[KS_XY_IDX]>tmpB[KS_XY_IDX]?1:tmpA[KS_XY_IDX]<tmpB[KS_XY_IDX]?-1:zsh_a-zsh_b});let size=Math.floor(list.length/tmpArr.length),mod=list.length%tmpArr.length,sizeArr=[size,size,size,size];for(let pakNo=0;pakNo<mod;pakNo++)sizeArr[pakNo]+=1;let idx=0;for(let pakNo=0;pakNo<list.length;pakNo++){let data=list[pakNo];tmpArr[idx].push(data),tmpArr[idx].length==sizeArr[idx]&&(idx+=1)}if(0!=mod)for(let pakNo=mod;pakNo<4;pakNo++)tmpArr[pakNo].push(EMPTY);let maxSize=tmpArr[0].length;for(let k=0;k<maxSize;k++){var pageNo=k+1;for(let pakNo=0;pakNo<4;pakNo++)fs.appendFileSync(okFilepath,iconv.encode('"'+pageNo+'",'+tmpArr[pakNo][k]+"\r\n","gbk"),"binary")}}let oNum1=1;for(let kddm in allDataInFile){let oNum2=0;for(let ssxx in allDataInFile[kddm]){let oNum3=0,listData=allDataInFile[kddm][ssxx];listData.sort((a,b)=>{var zsh_a=parseInt(a.KS_ZSH),zsh_b=parseInt(b.KS_ZSH);return a.KS_BMXQ>b.KS_BMXQ?1:a.KS_BMXQ<b.KS_BMXQ?-1:a.DM_MC>b.DM_MC?1:a.DM_MC<b.DM_MC?-1:a.KS_XY>b.KS_XY?1:a.KS_XY<b.KS_XY?-1:zsh_a-zsh_b});let currData=listData[0],bmxq=currData.KS_BMXQ,yyjb=currData.KS_YYJB,dm_mc=currData.DM_MC,pakSize=Math.floor(listData.length/500),pakSizeMod=listData.length%500,pakInfoData={};for(let pakNo=1;pakNo<=pakSize;pakNo++){let row=[],startIdx=500*(pakNo-1),endIdx=500*pakNo,currListData=listData.slice(startIdx,endIdx),firstNum=parseInt(currListData[0].KS_ZSH),lastNum=parseInt(currListData[currListData.length-1].KS_ZSH);row.push(firstNum),row.push(pakNo),row.push(kddm),row.push(bmxq),row.push(yyjb),row.push(500);let yxmzList="";for(var i=0,j=1;i<currListData.length;i++){let ymxz_=currListData[i].KS_XY_DM;ymxz_||(ymxz_=currListData[i].KS_XY);var name="、"+ymxz_+"    ";-1==yxmzList.indexOf(name)&&(yxmzList+=j+++name),pakInfoData["_"+currListData[i].KS_ZSH]=pakNo}row.push(firstNum),row.push(lastNum),row.push(dm_mc),row.push(yxmzList),row.push(sf),fs.appendFileSync(pakFilepath,iconv.encode(row.join(",")+"\r\n","gbk"),"binary")}if(pakSizeMod>0){let row=[],startIdx=500*pakSize,currListData=listData.slice(startIdx),firstNum=parseInt(currListData[0].KS_ZSH),lastNum=parseInt(currListData[currListData.length-1].KS_ZSH);row.push(firstNum),row.push(pakSize+1),row.push(kddm),row.push(bmxq),row.push(yyjb),row.push(pakSizeMod);let yxmzList="";for(var i=0,j=1;i<currListData.length;i++){let ymxz_=currListData[i].KS_XY_DM;ymxz_||(ymxz_=currListData[i].KS_XY);var name="、"+ymxz_+"    ";-1==yxmzList.indexOf(name)&&(yxmzList+=j+++name),pakInfoData["_"+currListData[i].KS_ZSH]=pakSize+1}row.push(firstNum),row.push(lastNum),row.push(dm_mc),row.push(yxmzList),row.push(sf),fs.appendFileSync(pakFilepath,iconv.encode(row.join(",")+"\r\n","gbk"),"binary")}let yxGroup={},pakGroup={};listData.forEach(currData=>{let nkey=(currData.KS_XY_DM?currData.KS_XY_DM:currData.KS_XY?currData.KS_XY:"--")+"-"+(""==currData.KS_BMXQ?"0":currData.KS_BMXQ);yxGroup[nkey]||(yxGroup[nkey]=[]),pakGroup[nkey]||(pakGroup[nkey]=[]);var zsh=currData.KS_ZSH,pakNo=pakInfoData["_"+zsh];yxGroup[nkey].push(currData),-1==pakGroup[nkey].indexOf(pakNo)&&pakGroup[nkey].push(parseInt(pakNo))});let rows=[];for(let dm in yxGroup){let xy_dm=dm.split("-")[0];bmxq=dm.split("-")[1];let yxList=yxGroup[dm],pakNos=pakGroup[dm];1==pakNos.length?pakNos.push(pakNos[0]):pakNos.sort((a,b)=>a-b),row=[],row.push(bmxq),row.push(xy_dm),row.push(dm_mc),row.push(yxList.length);let firstNum=parseInt(yxList[0].KS_ZSH),lastNum=parseInt(yxList[yxList.length-1].KS_ZSH);row.push(pakNos.join("-")),row.push(firstNum+"-"+lastNum),rows.push(row)}tables.push({"学校名称":dm_mc,"考点代码":kddm,rows:rows,size:listData.length})}}let ks_date=$("#ks_date").val(),ks_type=$("#ks_type").val(),tableInfo="考试成绩单统计表 ",tHead="<table width=100% cellspacing=0 cellpadding=2 class=table><tr><td width=10% class=header>所属校区</td><td width=10% class=header>院系代码</td><td width=25% class=header>院系名称</td><td width=10% class=header>数量</td><td width=10% class=header>所在包号</td><td width=35% class=header>号段</td></tr>",tFooter="<br clear=all style='mso-special-character:line-break;page-break-before:always'>",html=[];tables.forEach(table=>{html.push("<p class=title>"+ks_date+" &nbsp;&nbsp;&nbsp; "+ks_type+"  &nbsp;&nbsp;&nbsp; "+tableInfo+" &nbsp;&nbsp;&nbsp; 考点代码："+table["考点代码"]+" &nbsp;&nbsp;&nbsp; 学校名称："+table["学校名称"]+"</p>"),html.push(tHead),table.rows.forEach(row=>{html.push("<tr><td>"+row[0]+"</td><td>"+row[1]+"</td><td>"+row[2]+"</td><td>"+row[3]+"</td><td>"+row[4]+"</td><td>"+row[5]+"</td></tr>")}),html.push("</table>合计："+table.size),html.push(tFooter)});let xxtjpath=okFilepath.replace(".ok.csv",".学校统计.html");fs.writeFileSync(xxtjpath,templateHtml.replace("###content###",html.join(""))),html=null,tds[1].innerText="完成",html="共"+lineCount+"记录，",okFilepath=okFilepath.replace(/[\\]/g,"\\\\"),errFilepath=errFilepath.replace(/[\\]/g,"\\\\"),xxtjpath=xxtjpath.replace(/[\\]/g,"\\\\"),html+=0==errCount?"数据<a href=\"javascript:openFile('"+okFilepath+'\')" title="点击查看输出的合格文件">正确</a>，无异常数据':"数据<a href=\"javascript:openFile('"+okFilepath+'\')" title="点击查看合格文件">'+(lineCount-errCount)+"条正确</a><br/><a href=\"javascript:openFile('"+errFilepath+'\')" title="点击查看错误文件" style="color:red">'+errCount+"条错误</a>&nbsp;<a href=\"javascript:openFile('"+xxtjpath+'\')" title="点击查看学校统计">学校统计</a>',tds[2].innerHTML=html,progressData.len--,progressData.len<=0&&(setProgressbar(100),$("#btnData").removeAttr("disabled","disabled").removeClass("disabled"),layer.close(layerLoadIdx),alert("所有数据已处理完成","消息"))}))}function doit(obj){if(cleanCache(),0==tableData.length)return alert("还没有进行数据定义，请先设置数据"),void $(".nav-tabs li:last").find("a")[0].click();if(-1!=g_data_changed)return alert("设置被修改了，但并没有保存，请先你保存再继续！"),void $(".nav a")[g_data_changed].click();var allCheckboxes=$("#fileData .filecbx:checked");0!=allCheckboxes.length?(layerLoadIdx=layer.load(1),$(obj).attr("disabled","disabled").addClass("disabled"),defaultNavTab=1,configuration.saveSettings("defaultNavTab",defaultNavTab),setTimeout(()=>{setProgressbar(0,""),allCheckboxes.each((idx,input)=>{var cIdx=parseInt(input.value),file=allDataFiles[cIdx];file&&(progressData.len++,progressData.size+=file.size)}),allCheckboxes.each((idx,input)=>{var cIdx=parseInt(input.value),file=allDataFiles[cIdx];file&&analyticHandle(file,input)}),setTimeout(()=>{progressData.len<=0&&(setProgressbar(100),$("#btnData").removeAttr("disabled","disabled").removeClass("disabled"),layer.close(layerLoadIdx),alert("所有数据已处理完成","消息"))},1e4)},500)):alert("没有要处理的文件")}function doPatch(){let patchFile=$("#patchFile").val();if(""==patchFile)return void alert("请先选择数据文件");let lines=$("#patchTxt").val().trim().split(/[\n]/g);if(0==lines.length)return void alert("请按照补号格式输入补号内容");var buffer=Buffer.from(fs.readFileSync(patchFile,{encoding:"binary"}),"binary"),patchFileTxt;let patchFileLines=iconv.decode(buffer,"GBK").trim().split("\r\n"),okLines=[],EMPTY;for(var i=0;i<lines.length;i++){let line=lines[i].trim();if(2==line.split("-").length){let start=line.split("-")[0],end=line.split("-")[1];okLines=okLines.concat(patchFileLines.filter(patchLine=>{if(-1==patchLine.trim().indexOf(","))return!1;var zsh=patchLine.split(",")[1].replace(/["']/g,"").trim();return"0"!=zsh||EMPTY||(EMPTY=patchLine),""!=zsh&&start<=zsh&&end>=zsh}))}else if(3==line.split("+").length){var arr=line.split("+"),startIdx;for(startIdx=1;startIdx<patchFileLines.length;startIdx++){var patchLine=patchFileLines[startIdx];if(-1!=patchLine.trim().indexOf(",")){var zsh=patchLine.split(",")[1].replace(/["']/g,"").trim();if("0"!=zsh||EMPTY||(EMPTY=patchLine),arr[0]==zsh)break}}var count=parseInt(arr[2]),add=parseInt(arr[1]);okLines.push(arr[0]);for(var okIdx=add+startIdx,n=1;n<count;n++)okLines.push(patchFileLines[okIdx]),okIdx+=add}else{var numArr=line.split(/[,，]/g);numArr.length>0&&(okLines=okLines.concat(patchFileLines.filter(patchLine=>{if(-1==patchLine.trim().indexOf(","))return!1;var zsh=patchLine.split(",")[1].replace(/["']/g,"").trim();return"0"!=zsh||EMPTY||(EMPTY=patchLine),""!=zsh&&-1!=numArr.indexOf(zsh)})))}}var filepath=patchFile.split(".ok")[0]+".patch"+(patchFile.split(".ok")[1]||"");if(fs.appendFileSync(filepath,iconv.encode(patchFileLines[0]+"\r\n","gbk"),"binary"),!EMPTY){let firstLine,tmp=okLines[0].split(",");EMPTY="";let len=2;chk_tlmk&&(len=3);for(var i=0;i<tmp.length-len;i++)EMPTY+="0,";-1!=tmp[tmp.length-len].indexOf(".")?EMPTY+="empty.jpg,":EMPTY+="0,",-1!=tmp[tmp.length-len-1].indexOf(".")?EMPTY+="empty.jpg":EMPTY+="0",3==len&&(EMPTY+=",0")}let tmpArr=[[],[],[],[]],list=okLines,size=Math.floor(list.length/tmpArr.length),mod=list.length%tmpArr.length,sizeArr=[size,size,size,size];for(let pakNo=0;pakNo<mod;pakNo++)sizeArr[pakNo]+=1;let idx=0;for(let pakNo=0;pakNo<list.length;pakNo++){let data=list[pakNo];tmpArr[idx].push(data),tmpArr[idx].length==sizeArr[idx]&&(idx+=1)}if(0!=mod)for(let pakNo=mod;pakNo<4;pakNo++)tmpArr[pakNo].push(EMPTY);let maxSize=tmpArr[0].length;for(let k=0;k<maxSize;k++){var pageNo=k+1;for(let pakNo=0;pakNo<4;pakNo++)fs.appendFileSync(filepath,iconv.encode('"'+pageNo+'",'+tmpArr[pakNo][k].split(",").slice(1).join(",")+"\r\n","gbk"),"binary")}alert("补打文件已经生成："+filepath)}function getDateStr(){var now=new Date,year=now.getFullYear(),month=now.getMonth()+1,date=now.getDate(),hour=now.getHours(),minute=now.getMinutes(),second=now.getSeconds(),datetimestr;return""+year+(month<10?"0"+month:month)+(date<10?"0"+date:date)+(hour<10?"0"+hour:hour)+(minute<10?"0"+minute:minute)+(second<10?"0"+second:second)}function autoID(){document.getElementById("fileBtn").click()}function chooseFile(){g_data_changed=2;var filepath=document.getElementById("fileBtn").files[0].path,msg="";if(filepath)if(""!=filepath&&fs.existsSync(filepath)){var statsObj;fs.statSync(filepath).isFile()||(msg=filepath+" 不是有效文件")}else msg=filepath+" 无效路径";else msg="请选择文件";""!=msg?alert('<span style="color:red;font-weight:bold">'+msg+"</span>"):fs.readFile(filepath,"utf-8",(function(err,data){if(err)alert('<span style="color:red;font-weight:bold">'+JSON.stringify(err)+"</span>");else{var index=data.indexOf("\n");-1!=index&&(data=data.substring(0,index));var columns=(data=data.split(/[\r\n]/g)[0]).split(/,/);1==columns.length&&(columns=data.split(/[\t]/g)),tableData=[],columns.forEach(column=>{var c=column.replace(/["']/g,"").trim(),size=tableData.length+1;tableData.push({"说明":"字段"+size,"内容":c.toUpperCase(),"启用":!1,"排序号":size,"照片":!1,"二维码":!1})}),setTableData()}}))}function picChange(){var value=$("input:radio[name=chk_pic]:checked").val();if(console.log("picChange 当前值"+value),""!=value)if(-1!=(value=parseInt(value))){for(var i=0;i<tableData.length;i++)tableData[value]["照片"]=i==value?this.checke:!this.checke;defaultTableData[value]?tableData[value]["照片"]!=defaultTableData[value]["照片"]&&(g_data_changed=2):g_data_changed=2}else for(var i=0;i<tableData.length;i++)tableData[i]["照片"]=!1}function qrcodeChange(){var value=$("input:radio[name=chk_qrcode]:checked").val();if(console.log("qrcodeChange 当前值"+value),""!=value)if(-1!=(value=parseInt(value))){for(var i=0;i<tableData.length;i++)tableData[value]["二维码"]=i==value?this.checke:!this.checke;defaultTableData[value]?tableData[value]["二维码"]!=defaultTableData[value]["二维码"]&&(g_data_changed=2):g_data_changed=2}else for(var i=0;i<tableData.length;i++)tableData[i]["二维码"]=!1}function setTableData(){var html=[],hasPic=!1,hasQrcode=!1;tableData.forEach((item,idx)=>{html.push('<tr id="'+idx+'">'),html.push("<td>"+item["内容"]+"</td>"),html.push('<td><input type="text" value="'+item["说明"]+'" onchange="tableData['+idx+"]['说明']=this.value;g_data_changed=2;\" maxlength=15 />"),html.push('<input type="radio" name="chk_pic" id="chk_pic_'+idx+'" value="'+idx+'" '+(!hasPic&&item["照片"]?" checked ":"")+' onchange="picChange();"/><label for="chk_pic_'+idx+'">照片</label>'),html.push('<input type="radio" name="chk_qrcode" id="chk_qrcode_'+idx+'" value="'+idx+'" '+(!hasQrcode&&item["二维码"]?" checked ":"")+' onchange="qrcodeChange()"/><label for="chk_qrcode_'+idx+'">二维码</label>'),html.push('</td><td><input type="checkbox" id="chk_'+idx+'" '+(item["启用"]?" checked ":"")+' onchange="tableData['+idx+"]['启用']=this.checked;g_data_changed=2;\"/><label for=\"chk_"+idx+'">启用</label></td>'),html.push('<td><input type="number" style="width:50px" value="'+item["排序号"]+'" onchange="tableData['+idx+"]['排序号']=parseInt(this.value);g_data_changed=2;\"/> </td>"),html.push("</tr>"),!hasPic&&item["照片"]&&(hasPic=!0),!hasQrcode&&item["二维码"]&&(hasQrcode=!0)}),hasPic||$("#chk_pic_no").next()[0].click(),hasQrcode||$("#chk_qrcode_no").next()[0].click(),$("#tableData").html(html.join(""))}function splitFile(){$("#splitFileBtn").addClass("disabled").attr("disabled","disabled"),$("#splitFilesSelect").click()}function doSplitFile(){var files=document.querySelector("#splitFilesSelect").files;if(files.length>0){layerLoadIdx=layer.load(1);for(var msg=[],j=0;j<files.length;j++){for(var file,fullpath=files[j].path,extName=path.extname(fullpath),fullpath_0=fullpath.replace(extName,""),content,lines=fs.readFileSync(fullpath,"utf8").toString().split("\n"),headLine=lines[0].trim(),sfLines={},i=1;i<lines.length;i++){var line=lines[i].trim();if(""!=line.length){var fields=line.split(",");if(fields.length<2)console.info("无效行---\x3e行号："+i+",内容："+line);else{var sf,arr=sfLines[sf=fields[2].replace('"',"").substring(0,2)];arr||(arr=[headLine],sfLines[sf]=arr),arr.push(line)}}}for(var sf in sfLines){var filepath_=fullpath_0+"_"+sf+extName;msg.push("创建文件 "+path.basename(filepath_)),fs.writeFileSync(filepath_,sfLines[sf].join("\r\n"))}}layer.close(layerLoadIdx),alert(msg.join("<br/>"),"分隔文件处理完成"),$("#btnFindFile").click()}$("#splitFileBtn").removeClass("disabled").removeAttr("disabled")}module.exports={save:save,loadDefaultConfig:loadDefaultConfig,setFolder:setFolder,restore:restore,nextStep:nextStep,alert:alert,timeClose:timeClose,selectAll:selectAll,findFile:findFile,doit:doit,autoID:autoID,chooseFile:chooseFile};